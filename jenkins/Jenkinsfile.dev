pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Setup') {
            steps {
                script {
                    echo "Setting up environment..."
                    sh 'docker version'
                    sh 'chmod +x ci/smoke_test.sh'
                }
            }
        }

        stage('Parallel Build & Test') {
            parallel {
                stage('Runtime Node 18') {
                    steps {
                        script {
                            echo "Building on Node 18..."
                            // Use docker build with build-arg to avoid volume mount issues in DinD
                            sh 'docker build --build-arg NODE_VERSION=18 -t power_gym:test-18-${GIT_COMMIT} .'
                        }
                    }
                }
                stage('Runtime Node 20') {
                    steps {
                        script {
                            echo "Building on Node 20..."
                            sh 'docker build --build-arg NODE_VERSION=20 -t power_gym:test-20-${GIT_COMMIT} .'
                        }
                    }
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    sh 'docker build -t power_gym:dev-${GIT_COMMIT} .'
                }
            }
        }

        stage('Run (Docker)') {
            steps {
                script {
                    // Remove existing container if any
                    sh 'docker rm -f power_gym-dev || true'
                    // Run new container
                    sh 'docker run -d --name power_gym-dev -p 3001:80 power_gym:dev-${GIT_COMMIT}'
                }
            }
        }

        stage('Smoke Test') {
            steps {
                script {
                    // Wait for container to be fully ready
                    sleep(time: 10, unit: "SECONDS")
                    sh './ci/smoke_test.sh http://host.docker.internal:3001' 
                }
            }
        }

        stage('Archive Artifacts') {
            steps {
                archiveArtifacts artifacts: 'smoke_result.txt', fingerprint: true
            }
        }
    }

    post {
        always {
            // Cleanup container and images
            sh 'docker rm -f power_gym-dev || true'
            sh 'docker rmi power_gym:test-18-${GIT_COMMIT} || true'
            sh 'docker rmi power_gym:test-20-${GIT_COMMIT} || true'
        }
        cleanup {
            cleanWs()
        }
    }
}
